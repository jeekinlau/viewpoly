test_that("upload files",{
  # match values functions
  check_viewmap_values <- function(viewmap_obj, doses, phases, maps){
    expect_equal(as.vector(table(viewmap_obj$d.p1[[1]])), doses)
    expect_equal(as.vector(table(viewmap_obj$ph.p1[[1]][,3])), phases)
    expect_equal(as.vector(sum(viewmap_obj$maps[[1]][,2])), maps, tolerance = 0.001)
  }
  
  check_viewqtl_qtlpoly_values <- function(viewqtl_obj, pos, h2, u.hat, beta.hat, lod, effect, probs){
    expect_equal(sum(viewqtl_obj$selected_mks$pos), pos, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$qtl_info$h2), h2, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$blups$u.hat), u.hat, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$beta.hat$beta.hat), beta.hat, tolerance = 0.001)
    expect_equal(min(viewqtl_obj$profile$LOP), lod, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$effects$effect), effect, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$probs[,1,2]), probs, tolerance = 0.001)
  }
  
  check_viewqtl_diaqtl_values <- function(viewqtl_obj, pos, ll, DIC, effect){
    expect_equal(sum(viewqtl_obj$selected_mks$pos), pos, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$qtl_info$LL), ll, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$profile$deltaDIC), DIC, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$effects$effect, na.rm = T), effect, tolerance = 0.001)
  }
  
  check_viewqtl_polyqtlr_values <- function(viewqtl_obj, pos, thre, lod, effect){
    expect_equal(sum(viewqtl_obj$selected_mks$pos), pos, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$qtl_info$thresh), thre, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$profile$LOD), lod, tolerance = 0.001)
    expect_equal(sum(viewqtl_obj$effects[,4], na.rm = T), effect, tolerance = 0.001)
  }
  
  # upload examples
  viewpoly_obj <- prepare_examples("tetra_map")
  
  expect_equal(check_viewpoly(viewpoly_obj),0)
  
  check_viewmap_values(viewpoly_obj$map, 
                       c(14, 132, 139, 157, 34), 
                       c(36, 167, 164, 109), 
                       50502.07)
  
  check_viewqtl_qtlpoly_values(viewpoly_obj$qtl, 
                               116504, 
                               5.418909, 
                               -1.067457e-11, 
                               299.6155, 
                               0.000160791, 
                               2.340129e-12, 
                               1)
  
  # upload custom files
  dosages <- phases <- genetic_map <- mks_pos <- list()
  dosages$datapath <- system.file("ext/dosage.tsv.gz", package = "viewpoly")
  phases$datapath <- system.file("ext/phases.tsv.gz", package = "viewpoly")
  genetic_map$datapath <- system.file("ext/map.tsv.gz", package = "viewpoly")
  
  viewmap_obj <- prepare_map_custom_files(dosages, phases, genetic_map)
  
  expect_equal(check_viewmap(viewmap_obj),0)
  
  check_viewmap_values(viewmap_obj, 
                       c(887, 1063,543,188,54,10), 
                       c(181, 640, 671, 608, 645), 
                       401368.7)
  
  selected_mks <- qtl_info <- blups <- beta.hat <- profile <- effects <- probs <- list()
  selected_mks$datapath = system.file("ext/selected_mks.tsv.gz", package = "viewpoly")
  qtl_info$datapath = system.file("ext/qtl_info.tsv.gz", package = "viewpoly")
  blups$datapath = system.file("ext/blups.tsv.gz", package = "viewpoly")
  beta.hat$datapath = system.file("ext/beta.hat.tsv.gz", package = "viewpoly")
  profile$datapath = system.file("ext/profile.tsv.gz", package = "viewpoly")
  effects$datapath = system.file("ext/effects.tsv.gz", package = "viewpoly")
  probs$datapath = system.file("ext/probs.tsv.gz", package = "viewpoly")
  
  viewqtl_obj <- prepare_qtl_custom_files(selected_mks, qtl_info, blups, 
                                          beta.hat, profile, effects, probs)
  
  expect_equal(check_viewqtl(viewqtl_obj),0)
  
  check_viewqtl_qtlpoly_values(viewqtl_obj, 
                               245183.2, 
                               6.702273, 
                               3.091306e-10, 
                               341.4562, 
                               4.29507e-05, 
                               -7.647564e-11, 
                               1)
  
  # upload MAPpoly
  temp <- tempfile()
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_MAPpoly_maps.RData", destfile = temp)
  temp.name <- load(temp)
  input.data <- get(temp.name)
  viewmap_mappoly <- prepare_MAPpoly(input.data)
  
  expect_equal(check_viewmap(viewmap_mappoly),0)
  
  check_viewmap_values(viewmap_mappoly, 
                       c(14, 132, 139, 157, 34), 
                       c(250, 226), # bases codified as A and B
                       50502.07)
  
  # upload QTLpoly
  input.data <- remim.mod <- est.effects <- fitted.mod <- list()
  input.data$datapath <- tempfile()
  remim.mod$datapath <- tempfile()
  est.effects$datapath <- tempfile()
  fitted.mod$datapath <- tempfile()
  
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_QTLpoly_data.RData", destfile = input.data$datapath)
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_QTLpoly_remim.RData", destfile = remim.mod$datapath)
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_QTLpoly_effects.RData", destfile = est.effects$datapath)
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_QTLpoly_fitted.RData", destfile = fitted.mod$datapath)
  
  viewqtl_qtlpoly <- prepare_QTLpoly(data = input.data, 
                                     remim.mod = remim.mod, 
                                     est.effects = est.effects, 
                                     fitted.mod = fitted.mod)
  
  expect_equal(check_viewqtl(viewqtl_qtlpoly),0)
  
  check_viewqtl_qtlpoly_values(viewqtl_qtlpoly, 
                               116504, 
                               5.418909, 
                               -1.067457e-11, 
                               299.6155, 
                               0.000160791, 
                               2.340129e-12, 
                               1)
  
  # upload diaQTL
  scan1_list <- scan1_summaries_list <- fitQTL_list <- BayesCI_list <- list()
  scan1_list$datapath <- tempfile()
  scan1_summaries_list$datapath <- tempfile()
  fitQTL_list$datapath <- tempfile()
  BayesCI_list$datapath <- tempfile()
  
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_diaQTL_scan1_list.RData", destfile = scan1_list$datapath)
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_diaQTL_scan1_summaries_list.RData", destfile = scan1_summaries_list$datapath)
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_diaQTL_fitQTL_list%20%281%29.RData", destfile = fitQTL_list$datapath)
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_diaQTL_BayesCI_list_0.RData", destfile = BayesCI_list$datapath)
  
  viewqtl_diaqtl <- viewpoly:::prepare_diaQTL(scan1_list,
                                              scan1_summaries_list,
                                              fitQTL_list,
                                              BayesCI_list)
  
  expect_equal(check_viewqtl(viewqtl_obj = viewqtl_diaqtl),0)
  
  check_viewqtl_diaqtl_values(viewqtl_diaqtl, 402196.1, -2111.243, -10553.94, -1.689251)
  
  # upload polyqtlR
  polyqtlR_QTLscan_list <- polyqtlR_qtl_info <- polyqtlR_effects <- list()
  polyqtlR_QTLscan_list$datapath <- tempfile()
  polyqtlR_qtl_info$datapath <- tempfile()
  polyqtlR_effects$datapath <- tempfile()

  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_polyqtlR_QTLscan.RData", destfile = polyqtlR_QTLscan_list$datapath)
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_polyqtlR_qtl_info.RData", destfile = polyqtlR_qtl_info$datapath)
  download.file("https://www.polyploids.org/sites/default/files/2022-04/tetra_polyqtlR_effects.RData", destfile = polyqtlR_effects$datapath)
  
  viewqtl_polyqtlr <- viewpoly:::prepare_polyqtlR(polyqtlR_QTLscan_list, polyqtlR_qtl_info, polyqtlR_effects)
  
  expect_equal(check_viewqtl(viewqtl_obj = viewqtl_polyqtlr),0)
  
  check_viewqtl_polyqtlr_values(viewqtl_polyqtlr, 287322.2, 103.8376, 210404.7, 6032.891)
})

